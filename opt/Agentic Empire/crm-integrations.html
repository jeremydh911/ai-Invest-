<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Integrations - AgenticEmpire</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .navbar { 
      background: rgba(255,255,255,0.95); 
      padding: 1rem 2rem; 
      border-radius: 10px;
      margin-bottom: 2rem;
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .navbar h1 { color: #667eea; font-size: 1.8rem; }
    
    .navbar-links {
      display: flex;
      gap: 1rem;
    }
    
    .navbar-links a {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .navbar-links a:hover {
      background: #667eea;
      color: white;
    }
    
    .page-header {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .page-header h1 { color: #667eea; margin-bottom: 0.5rem; font-size: 2.5rem; }
    .page-header p { color: #666; font-size: 1.1rem; }
    
    .integrations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .integration-card {
      background: white;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    
    .integration-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .integration-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .integration-icon {
      font-size: 3rem;
      margin-right: 1rem;
    }
    
    .integration-name h2 {
      color: #333;
      margin-bottom: 0.25rem;
    }
    
    .integration-name p {
      color: #999;
      font-size: 0.9rem;
    }
    
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .status-connected { background: #d4edda; color: #155724; }
    .status-disconnected { background: #f8d7da; color: #721c24; }
    .status-syncing { background: #cce5ff; color: #004085; }
    
    .integration-form {
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    
    .toggle-group {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .toggle-switch {
      width: 50px;
      height: 28px;
      background: #ccc;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
    }
    
    .toggle-switch.active {
      background: #28a745;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
    }
    
    .toggle-switch.active::after {
      left: 24px;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .btn {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .sync-stats {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    
    .sync-stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .sync-stat-row:last-child { margin-bottom: 0; }
    
    .sync-stat-label { color: #666; }
    .sync-stat-value { font-weight: 600; color: #667eea; }
    
    .unified-search {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .unified-search h2 {
      color: #667eea;
      margin-bottom: 1.5rem;
    }
    
    .search-box {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .search-box input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }
    
    .search-box select {
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }
    
    .search-box button {
      padding: 0.75rem 1.5rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .search-results {
      margin-top: 2rem;
    }
    
    .results-section {
      margin-bottom: 2rem;
    }
    
    .results-section h3 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .result-item {
      padding: 1rem;
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .result-item:hover {
      background: #f0f0f0;
      border-left-color: #5568d3;
    }
    
    .result-name {
      font-weight: 600;
      color: #333;
    }
    
    .result-meta {
      color: #999;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }
    
    .sync-history {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .sync-history h2 {
      color: #667eea;
      margin-bottom: 1.5rem;
    }
    
    .history-item {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .history-item:last-child { border-bottom: none; }
    
    .history-source {
      font-weight: 600;
      color: #333;
    }
    
    .history-time {
      color: #999;
      font-size: 0.9rem;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }
    
    .alert.show { display: block; }
    .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    
    .loading {
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #667eea;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .data-browser {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .data-browser h2 {
      color: #667eea;
      margin-bottom: 1.5rem;
    }
    
    .data-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .data-tab {
      padding: 1rem;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      color: #999;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    
    .data-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .data-content {
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .data-content.active { display: block; }
    
    .data-item {
      padding: 1rem;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    
    .data-item-header {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }
    
    .data-item-meta {
      color: #999;
      font-size: 0.85rem;
    }
    
    @media (max-width: 768px) {
      .integrations-grid { grid-template-columns: 1fr; }
      .search-box { flex-direction: column; }
      .navbar { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h1>üîó CRM Integrations</h1>
      <div class="navbar-links">
        <a href="/dashboard.html">Dashboard</a>
        <a href="/crm.html">CRM</a>
        <a href="/settings.html">Settings</a>
      </div>
    </div>

    <div class="page-header">
      <h1>üîó Unified CRM Integrations</h1>
      <p>Connect to and synchronize data with Brivity, TopProducer, and other CRM platforms. All data is cached in memory for instant access.</p>
    </div>

    <div id="alertContainer"></div>

    <!-- CRM Integration Cards -->
    <div class="integrations-grid">
      <!-- Brivity Integration -->
      <div class="integration-card">
        <div class="integration-header">
          <div>
            <div class="integration-icon">üè¢</div>
            <div class="integration-name">
              <h2>Brivity</h2>
              <p>Real Estate CRM</p>
            </div>
          </div>
          <div class="status-badge" id="brivityStatus">Disconnected</div>
        </div>

        <div class="integration-form">
          <div class="form-group">
            <label>API Base URL</label>
            <input type="text" id="brivityUrl" placeholder="https://api.brivity.com/v1" value="https://api.brivity.com/v1">
          </div>
          
          <div class="form-group">
            <label>Client ID</label>
            <input type="text" id="brivityClientId" placeholder="Your Brivity Client ID">
          </div>
          
          <div class="form-group">
            <label>Client Secret</label>
            <input type="password" id="brivityClientSecret" placeholder="Your Brivity Client Secret">
          </div>

          <div class="toggle-group">
            <label>Enable Brivity Integration</label>
            <buttonclass="toggle-switch" id="brivityToggle"></button>
          </div>

          <div class="sync-stats" id="brivityStats">
            <div class="sync-stat-row">
              <span class="sync-stat-label">Cached Contacts:</span>
              <span class="sync-stat-value" id="brivityContactCount">0</span>
            </div>
            <div class="sync-stat-row">
              <span class="sync-stat-label">Cached Deals:</span>
              <span class="sync-stat-value" id="brivityDealCount">0</span>
            </div>
            <div class="sync-stat-row">
              <span class="sync-stat-label">Last Sync:</span>
              <span class="sync-stat-value" id="brivityLastSync">Never</span>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="syncBrivity()">
            <span id="brivitySyncText">Sync Now</span>
          </button>
          <button class="btn btn-secondary" onclick="testBrivityConnection()">Test Connection</button>
        </div>
      </div>

      <!-- TopProducer Integration -->
      <div class="integration-card">
        <div class="integration-header">
          <div>
            <div class="integration-icon">üéØ</div>
            <div class="integration-name">
              <h2>TopProducer</h2>
              <p>Real Estate Management</p>
            </div>
          </div>
          <div class="status-badge" id="topproducerStatus">Disconnected</div>
        </div>

        <div class="integration-form">
          <div class="form-group">
            <label>API Base URL</label>
            <input type="text" id="topproducerUrl" placeholder="https://api.topproducerpro.com/v2" value="https://api.topproducerpro.com/v2">
          </div>
          
          <div class="form-group">
            <label>Client ID</label>
            <input type="text" id="topproducerClientId" placeholder="Your TopProducer Client ID">
          </div>
          
          <div class="form-group">
            <label>Client Secret</label>
            <input type="password" id="topproducerClientSecret" placeholder="Your TopProducer Client Secret">
          </div>

          <div class="toggle-group">
            <label>Enable TopProducer Integration</label>
            <buttonclass="toggle-switch" id="topproducerToggle"></button>
          </div>

          <div class="sync-stats" id="topproducerStats">
            <div class="sync-stat-row">
              <span class="sync-stat-label">Cached Contacts:</span>
              <span class="sync-stat-value" id="topproducerContactCount">0</span>
            </div>
            <div class="sync-stat-row">
              <span class="sync-stat-label">Cached Deals:</span>
              <span class="sync-stat-value" id="topproducerDealCount">0</span>
            </div>
            <div class="sync-stat-row">
              <span class="sync-stat-label">Last Sync:</span>
              <span class="sync-stat-value" id="topproducerLastSync">Never</span>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="syncTopProducer()">
            <span id="topproducerSyncText">Sync Now</span>
          </button>
          <button class="btn btn-secondary" onclick="testTopProducerConnection()">Test Connection</button>
        </div>
      </div>
    </div>

    <!-- Unified Search -->
    <div class="unified-search">
      <h2>üîç Unified CRM Search</h2>
      <p style="color: #666; margin-bottom: 1.5rem;">Search across all connected CRM platforms and local CRM at once.</p>
      
      <div class="search-box">
        <input type="text" id="unifiedSearchInput" placeholder="Search contacts, deals, companies..." onkeyup="handleSearchInput(event)">
        < selectedcontent="searchType" onchange="resetSearch()" > 
            <option value="all">All</option>
          <option value="contact">Contacts</option>
          <option value="deal">Deals</option>
        </select>
        <button onclick="performUnifiedSearch()">Search</button>
      </div>

      <div class="search-results" id="searchResults" style="display: none;">
        <div class="results-section" id="localResults"></div>
        <div class="results-section" id="brivityResults"></div>
        <div class="results-section" id="topproducerResults"></div>
      </div>
    </div>

    <!-- Data Browser -->
    <div class="data-browser">
      <h2>üìä Data Browser</h2>
      <p style="color: #666; margin-bottom: 1.5rem;">Browse all cached data from your CRM integrations.</p>
      
      <div class="data-tabs">
        <button class="data-tab active" onclick="switchDataTab('local')">Local CRM</button>
        <button class="data-tab" onclick="switchDataTab('brivity')">Brivity Data</button>
        <button class="data-tab" onclick="switchDataTab('topproducer')">TopProducer Data</button>
      </div>

      <div class="data-content active" id="localContent"></div>
      <div class="data-content" id="brivityContent"></div>
      <div class="data-content" id="topproducerContent"></div>
    </div>

    <!-- Sync History -->
    <div class="sync-history">
      <h2>üìÖ Sync Status</h2>
      <div id="syncHistory"></div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('authToken');

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} show`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    async function syncBrivity() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      
      try {
        const response = await fetch('/api/crm/integrations/sync/brivity', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success) {
          showAlert('‚úÖ Brivity sync completed successfully', 'success');
          await updateSyncStatus();
        } else {
          showAlert('‚ùå Brivity sync failed: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('Error during sync: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync Now';
      }
    }

    async function syncTopProducer() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Syncing...';
      
      try {
        const response = await fetch('/api/crm/integrations/sync/topproducer', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success) {
          showAlert('‚úÖ TopProducer sync completed successfully', 'success');
          await updateSyncStatus();
        } else {
          showAlert('‚ùå TopProducer sync failed: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('Error during sync: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync Now';
      }
    }

    async function updateSyncStatus() {
      try {
        const response = await fetch('/api/crm/integrations/sync-status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        const status = result.status;

        // Update Brivity
        document.getElementById('brivityStatus').textContent = status.brivity.status || 'Idle';
        document.getElementById('brivityStatus').className = 
          `status-badge status-${status.brivity.status === 'syncing' ? 'syncing' : 'connected'}`;
        document.getElementById('brivityContactCount').textContent = status.brivity.contactCount;
        document.getElementById('brivityDealCount').textContent = status.brivity.dealCount;
        if (status.brivity.lastSync) {
          document.getElementById('brivityLastSync').textContent = new Date(status.brivity.lastSync).toLocaleString();
        }

        // Update TopProducer
        document.getElementById('topproducerStatus').textContent = status.topproducer.status || 'Idle';
        document.getElementById('topproducerStatus').className = 
          `status-badge status-${status.topproducer.status === 'syncing' ? 'syncing' : 'connected'}`;
        document.getElementById('topproducerContactCount').textContent = status.topproducer.contactCount;
        document.getElementById('topproducerDealCount').textContent = status.topproducer.dealCount;
        if (status.topproducer.lastSync) {
          document.getElementById('topproducerLastSync').textContent = new Date(status.topproducer.lastSync).toLocaleString();
        }
      } catch (error) {
        console.error('Failed to update sync status:', error);
      }
    }

    async function performUnifiedSearch() {
      const query = document.getElementById('unifiedSearchInput').value;
      const type = document.getElementById('searchType').value;

      if (query.length < 2) {
        showAlert('Please enter at least 2 characters', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/crm/integrations/search?q=${encodeURIComponent(query)}&type=${type}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();

        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('localResults').innerHTML = renderResults('Local CRM', result.results.local);
        document.getElementById('brivityResults').innerHTML = renderResults('Brivity', result.results.brivity);
        document.getElementById('topproducerResults').innerHTML = renderResults('TopProducer', result.results.topproducer);
      } catch (error) {
        showAlert('Search failed: ' + error.message, 'error');
      }
    }

    function renderResults(source, items) {
      if (items.length === 0) return '';
      
      let html = `<h3>${source} (${items.length} results)</h3>`;
      items.forEach(item => {
        const name = item.first_name ? `${item.first_name} ${item.last_name}` : item.name;
        const meta = item.email ? item.email : (item.stage ? `Stage: ${item.stage}` : '');
        html += `
          <div class="result-item">
            <div class="result-name">${name}</div>
            <div class="result-meta">${meta}</div>
          </div>
        `;
      });
      return html;
    }

    function handleSearchInput(event) {
      if (event.key === 'Enter') performUnifiedSearch();
    }

    function resetSearch() {
      document.getElementById('searchResults').style.display = 'none';
    }

    function testBrivityConnection() {
      showAlert('üîß Testing Brivity connection...', 'info');
      // Connection test would be implemented in actual deployment
    }

    function testTopProducerConnection() {
      showAlert('üîß Testing TopProducer connection...', 'info');
      // Connection test would be implemented in actual deployment
    }

    async function switchDataTab(tab) {
      // Update active tab
      document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // Update content display
      document.querySelectorAll('.data-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tab}Content`).classList.add('active');

      // Load data
      try {
        const response = await fetch(`/api/crm/integrations/contacts?source=${tab}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        const contacts = Array.isArray(result.contacts) ? result.contacts : result.contacts[tab] || [];
        
        let html = '<h4 style="color: #667eea; margin-bottom: 1rem;">Contacts</h4>';
        if (contacts.length === 0) {
          html += '<p style="color: #999;">No contacts found</p>';
        } else {
          contacts.slice(0, 20).forEach(contact => {
            html += `
              <div class="data-item">
                <div class="data-item-header">${contact.first_name} ${contact.last_name}</div>
                <div class="data-item-meta">${contact.email || ''} | ${contact.company || ''}</div>
              </div>
            `;
          });
        }
        document.getElementById(`${tab}Content`).innerHTML = html;
      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      updateSyncStatus();
      switchDataTab('local');
      
      // Refresh sync status every 30 seconds
      setInterval(updateSyncStatus, 30000);
    });
  </script>
</body>
</html>
